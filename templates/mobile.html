<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>San AI Mobile</title>
    <link rel="manifest" href="/manifest.json">
    <style>
        body {
            margin: 0;
            padding: 10px;
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
        }
        .chat-container {
            height: calc(100vh - 120px);
            overflow-y: auto;
        }
        .controls {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 20px;
            background: white;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
        }
        .mic-button {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: #007AFF;
            border: none;
            color: white;
            font-size: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto;
        }
        .mic-button.active {
            background: #FF3B30;
        }
    </style>
</head>
<body>
    <div class="chat-container" id="chat"></div>
    <div class="controls">
        <button id="micButton" class="mic-button">ðŸŽ¤</button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.1/socket.io.js"></script>
    <script>
        let socket;
        let mediaRecorder;
        let audioChunks = [];
        let isRecording = false;

        async function initializeAudio() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ 
                    audio: {
                        echoCancellation: true,
                        noiseSuppression: true,
                        sampleRate: 16000
                    }
                });
                
                socket = io();
                
                mediaRecorder = new MediaRecorder(stream);
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        socket.emit('audio_stream', event.data);
                    }
                };

                socket.on('transcription', (data) => {
                    addMessage('San', data.text);
                });

                const micButton = document.getElementById('micButton');
                micButton.addEventListener('touchstart', startRecording);
                micButton.addEventListener('touchend', stopRecording);
            } catch (err) {
                console.error('Erreur:', err);
            }
        }

        function startRecording() {
            if (!isRecording) {
                isRecording = true;
                document.getElementById('micButton').classList.add('active');
                mediaRecorder.start(100); // Envoyer des chunks toutes les 100ms
            }
        }

        function stopRecording() {
            if (isRecording) {
                isRecording = false;
                document.getElementById('micButton').classList.remove('active');
                mediaRecorder.stop();
            }
        }

        function addMessage(sender, text) {
            const chat = document.getElementById('chat');
            const msg = document.createElement('div');
            msg.innerHTML = `<p><strong>${sender}:</strong> ${text}</p>`;
            chat.appendChild(msg);
            chat.scrollTop = chat.scrollHeight;
        }

        // Initialiser quand la page est chargÃ©e
        document.addEventListener('DOMContentLoaded', initializeAudio);
    </script>
</body>
</html>
